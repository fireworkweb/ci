fwd-tools:
  stage: deploy
  environment: $CI_COMMIT_BRANCH
  only:
    - develop@firework/erp
    - staging@firework/erp
  image: fireworkweb/k8s:1.2.1
  services:
    - docker:dind
  tags:
    - dind
  before_script:
    - doctl auth init --access-token=$DO_TOKEN
    - doctl registry login
    - doctl kubernetes cluster kubeconfig save fwd
  script:
    - docker build --cache-from registry.digitalocean.com/fwd/$FWD_TOOLS_ORG-$FWD_TOOLS_GROUP-$FWD_TOOLS_PROJECT-app:$CI_COMMIT_BRANCH --tag registry.digitalocean.com/fwd/$FWD_TOOLS_ORG-$FWD_TOOLS_GROUP-$FWD_TOOLS_PROJECT-app:$CI_COMMIT_BRANCH -f Dockerfile.app .
    - docker build --cache-from registry.digitalocean.com/fwd/$FWD_TOOLS_ORG-$FWD_TOOLS_GROUP-$FWD_TOOLS_PROJECT-app:$CI_COMMIT_BRANCH --tag registry.digitalocean.com/fwd/$FWD_TOOLS_ORG-$FWD_TOOLS_GROUP-$FWD_TOOLS_PROJECT-http:$CI_COMMIT_BRANCH -f Dockerfile.http .
    - docker push registry.digitalocean.com/fwd/$FWD_TOOLS_ORG-$FWD_TOOLS_GROUP-$FWD_TOOLS_PROJECT-app:$CI_COMMIT_BRANCH
    - docker push registry.digitalocean.com/fwd/$FWD_TOOLS_ORG-$FWD_TOOLS_GROUP-$FWD_TOOLS_PROJECT-http:$CI_COMMIT_BRANCH
    - helm upgrade --install --atomic --namespace=$FWD_TOOLS_ENV-$FWD_TOOLS_ORG-$FWD_TOOLS_GROUP-$FWD_TOOLS_PROJECT --create-namespace $FWD_TOOLS_HELM_RELEASE --repo=$FWD_TOOLS_HELM_REPO --version=$FWD_TOOLS_HELM_VERSION $FWD_TOOLS_HELM_CHART -f $FWD_TOOLS_HELM_VALUES
  dependencies:
    - assets
    - vendor
  # variables:
  #   FWD_TOOLS_ENV: ""
  #   FWD_TOOLS_ORG: ""
  #   FWD_TOOLS_GROUP: ""
  #   FWD_TOOLS_PROJECT: ""
  #   FWD_TOOLS_HELM_RELEASE: ""
  #   FWD_TOOLS_HELM_REPO: ""
  #   FWD_TOOLS_HELM_VERSION: ""
  #   FWD_TOOLS_HELM_CHART: ""
  #   FWD_TOOLS_HELM_VALUES: ""
